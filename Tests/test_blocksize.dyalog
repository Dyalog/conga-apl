 r←test_blocksize dummy;hh;hb;hhnc;blksize;ret;Port;srv;maxwait;Host;z;testname;body;header;headern;sets
⍝ Test different boundries of the http protocol
 Port←5000 ⋄ Host←'localhost'
 srv←'S1'
 maxwait←5000

 header←⎕UCS 72 84 84 80 47 49 46 49 32 50 48 48 32 79 75 13 10 68 97 116 101 58 32 84 117 101 44 32 49 50 32 74 97 110 32 50 48 49 54 32 49 54 58 49 49 58 53 55 32 71 77 84 13 10 83 101 114 118 101 114 58 32 65 112 97 99 104 101 47 50 46 52 46 55 32 40 85 98 117 110 116 117 41 13 10 76 97 115 116 45 77 111 100 105 102 105 101 100 58 32 83 97 116 44 32 48 55 32 77 97 114 32 50 48 49 53 32 49 54 58 49 57 58 51 51 32 71 77 84 13 10 69 84 97 103 58 32 34 51 56 56 45 53 49 48 98 53 50 97 57 100 101 50 99 56 34 13 10 65 99 99 101 112 116 45 82 97 110 103 101 115 58 32 98 121 116 101 115 13 10 67 111 110 116 101 110 116 45 76 101 110 103 116 104 58 32 57 48 52 13 10 86 97 114 121 58 32 65 99 99 101 112 116 45 69 110 99 111 100 105 110 103 13 10 67 111 110 116 101 110 116 45 84 121 112 101 58 32 116 101 120 116 47 104 116 109 108 13 10 13 10
 body←⎕UCS 60 33 68 79 67 84 89 80 69 32 72 84 77 76 32 80 85 66 76 73 67 32 34 45 47 47 87 51 67 47 47 68 84 68 32 72 84 77 76 32 52 46 48 49 47 47 69 78 34 32 34 104 116 116 112 58 47 47 119 119 119 46 119 51 46 111 114 103 47 84 82 47 104 116 109 108 52 47 115 116 114 105 99 116 46 100 116 100 34 62 13 10 60 104 116 109 108 62 13 10 60 104 101 97 100 62 13 10 60 109 101 116 97 32 110 97 109 101 61 34 100 101 115 99 114 105 112 116 105 111 110 34 32 99 111 110 116 101 110 116 61 34 83 109 105 116 104 32 102 97 109 105 108 121 32 110 101 119 115 34 62 13 10 60 109 101 116 97 32 104 116 116 112 45 101 113 117 105 118 61 34 80 114 97 103 109 97 34 32 99 111 110 116 101 110 116 61 34 110 111 99 97 99 104 101 34 62 13 10 60 109 101 116 97 32 104 116 116 112 45 101 113 117 105 118 61 34 69 120 112 105 114 101 115 34 32 99 111 110 116 101 110 116 61 34 45 49 34 62 13 10 60 116 105 116 108 101 62 83 109 105 116 104 32 70 97 109 105 108 121 32 78 101 119 115 60 47 116 105 116 108 101 62 13 10 60 108 105 110 107 32 116 121 112 101 61 34 116 101 120 116 47 99 115 115 34 32 114 101 108 61 34 115 116 121 108 101 115 104 101 101 116 34 32 104 114 101 102 61 34 115 116 121 108 101 46 99 115 115 34 62 13 10 60 47 104 101 97 100 62 13 10 60 98 111 100 121 62 13 10 60 104 49 62 119 119 119 46 83 109 105 116 104 45 70 97 109 105 108 121 45 78 101 119 115 46 99 111 46 117 107 60 47 104 49 62 13 10 13 10 60 112 62 13 10 32 32 60 98 62 84 111 32 97 99 99 101 115 115 32 116 104 105 115 32 115 105 116 101 32 121 111 117 32 110 101 101 100 32 97 32 117 115 101 114 105 100 32 97 110 100 32 112 97 115 115 119 111 114 100 46 60 47 98 62 13 10 60 47 112 62 13 10 60 112 62 13 10 32 32 84 104 101 32 117 115 101 114 105 100 32 105 115 32 60 98 62 115 102 110 60 47 98 62 46 13 10 60 47 112 62 13 10 60 112 62 13 10 32 32 84 104 101 32 112 97 115 115 119 111 114 100 32 105 115 32 99 111 110 115 116 114 117 99 116 101 100 32 102 114 111 109 32 116 104 101 32 102 105 114 115 116 32 116 119 111 32 108 101 116 116 101 114 115 32 111 102 32 116 104 101 32 110 97 109 101 115 32 111 102 13 10 32 32 101 97 99 104 32 109 101 109 98 101 114 32 111 102 32 116 104 101 32 102 97 109 105 108 121 44 32 111 108 100 101 115 116 32 102 105 114 115 116 46 13 10 32 32 60 98 114 62 70 111 114 32 101 120 97 109 112 108 101 44 32 105 102 32 116 104 111 115 101 32 110 97 109 101 115 32 119 101 114 101 32 60 98 62 72 111 60 47 98 62 109 101 114 44 32 60 98 62 77 97 60 47 98 62 114 103 101 44 32 60 98 62 66 97 60 47 98 62 114 116 44 13 10 32 32 60 98 62 76 105 60 47 98 62 115 97 32 97 110 100 32 60 98 62 77 97 60 47 98 62 103 103 105 101 32 116 104 101 32 112 97 115 115 119 111 114 100 32 119 111 117 108 100 32 98 101 32 60 98 62 104 111 109 97 98 97 108 105 109 97 60 47 98 62 46 13 10 60 47 112 62 13 10 60 112 62 13 10 32 32 84 111 32 99 111 110 116 105 110 117 101 58 13 10 60 47 112 62 13 10 60 112 62 13 10 32 32 60 98 62 60 97 32 104 114 101 102 61 115 101 99 117 114 101 47 105 110 100 101 120 46 104 116 109 108 62 67 108 105 99 107 32 104 101 114 101 60 47 97 62 60 47 98 62 13 10 60 47 112 62 13 10 60 47 98 111 100 121 62 13 10 60 47 104 116 109 108 62 13 10
 headern←⎕UCS 72 84 84 80 47 49 46 49 32 50 48 48 32 79 75 13 10 68 97 116 101 58 32 84 117 101 44 32 49 50 32 74 97 110 32 50 48 49 54 32 49 54 58 49 49 58 53 55 32 71 77 84 13 10 83 101 114 118 101 114 58 32 65 112 97 99 104 101 47 50 46 52 46 55 32 40 85 98 117 110 116 117 41 13 10 76 97 115 116 45 77 111 100 105 102 105 101 100 58 32 83 97 116 44 32 48 55 32 77 97 114 32 50 48 49 53 32 49 54 58 49 57 58 51 51 32 71 77 84 13 10 69 84 97 103 58 32 34 51 56 56 45 53 49 48 98 53 50 97 57 100 101 50 99 56 34 13 10 65 99 99 101 112 116 45 82 97 110 103 101 115 58 32 98 121 116 101 115 13 10 86 97 114 121 58 32 65 99 99 101 112 116 45 69 110 99 111 100 105 110 103 13 10 67 111 110 116 101 110 116 45 84 121 112 101 58 32 116 101 120 116 47 104 116 109 108 13 10 13 10

 sets←(header body'original')((header~⎕UCS 13)body'No linefeed')((('904'⎕R'0'⎕OPT'Mode' 'D')header)'' 'Nobody')(headern'' 'No content-length')
 :If 0 check⊃ret←iConga.SetProp'.' 'EventMode' 0
     →fail because'Set EventMode to 0 failed: ',,⍕ret ⋄ :EndIf

 :If (0 srv)check ret←iConga.Srv srv''Port'text'(8×⊃⍴header,body)
     →fail because'Srv failed: ',,⍕ret ⋄ :EndIf

 :For (hh hb testname) :In sets
     blksize←0

     :If 0 check⊃⍴ret←(¯4+⍴hh)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' Block size too small failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(100000)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' Big Header buffer failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←((⊃⍴hh)+⌊(⊃⍴hb)÷2)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' Middle of message body failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←((⊃⍴hh,hb,hh)+⌊(⊃⍴hb)÷2)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' Middle of  second message body failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(⊃⍴hh)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' just room for the header failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(⊃⍴hh,hb)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),'  room for first header and body failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(¯1+⊃⍴hh,hb)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' nearly room for first header and body failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(⊃⍴hh,hb,hh)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),'  room for first header and body and 2nd header failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(¯1+⊃⍴hh,hb,hh)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' nearly room for above failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(¯4+⊃⍴hh,hb,hh)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' nearly room for above (none of CRLFCRLF) failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(⊃⍴hh,hb,hh,hb)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' room for both headers and bodies failed: ',,⍕ret ⋄ :EndIf

     :If 0 check⊃⍴ret←(¯1+⊃⍴hh,hb,hh,hb)BlockSize(Host Port srv hh hb)
         →fail because(⍕blksize),' nearly room for both headers and bodies failed: ',,⍕ret ⋄ :EndIf
 :EndFor
 z←iConga.Close srv
 r←''   ⍝ surprise all worked!
 →0
fail:
 r←r,' for ',testname
